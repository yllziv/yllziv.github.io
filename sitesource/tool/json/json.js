function updateSelectHistory(t){for(var o='<option selected="selected" class="display-none">请选择历史纪录</option>',n=0;n<t.length;n++)o+='<option value="'+t[n]+'">'+decodeURI(t[n])+"</option>";$(".json-history").html(o)}function formatJSON(txt,compress){var indentChar="    ";if(/^\s*$/.test(txt))return void alert("数据为空,无法格式化! ");try{var data=eval("("+txt+")")}catch(e){return void alert("数据源语法错误,格式化失败! 错误信息: "+e.description,"err")}var draw=[],last=!1,This=this,line=compress?"":"\n",nodeCount=0,maxDepth=0,notify=function(t,o,n,e,r){nodeCount++;for(var i=0,s="";i<e;i++)s+=indentChar;if(s=compress?"":s,maxDepth=++e,o&&o.constructor==Array){draw.push(s+(r?'"'+t+'":':"")+"["+line);for(var i=0;i<o.length;i++)notify(i,o[i],i==o.length-1,e,!1);draw.push(s+"]"+(n?line:","+line))}else if(o&&"object"==typeof o){draw.push(s+(r?'"'+t+'":':"")+"{"+line);var l=0,i=0;for(var a in o)l++;for(var a in o)notify(a,o[a],++i==l,e,!0);draw.push(s+"}"+(n?line:","+line))}else"string"==typeof o&&(o='"'+o+'"'),draw.push(s+(r?'"'+t+'":':"")+o+(n?"":",")+line)},isLast=!0,indent=0;return notify("",data,isLast,indent,!1),draw.join("")}$(document).ready(function(){$("iframe",window.parent.document).height($("#tool").height()),$(window).resize(function(){$("iframe",window.parent.document).height($("#tool").height())});var jsonString=null,historyJsonArray=[];window.localStorage.getItem("historyJsonArray")&&(historyJsonArray=window.localStorage.getItem("historyJsonArray").split(","),updateSelectHistory(historyJsonArray)),$(".tool-source").bind("keyup mouseup",function(){var txt=$(this).val();/^\s*$/.test(txt)&&$("#destJSON").html("数据为空,无法格式化! ");try{var data=eval("("+txt+")");jsonString=JSON.stringify(data),$("#destJSON").JSONView(data),$("#rowJSON").is(":visible")&&$("#rowJSON").show().val(formatJSON(jsonString))}catch(e){$("#destJSON").html("数据源语法错误,格式化失败!"),jsonString=""}}),$("#collapse-btn").on("click",function(){$("#destJSON").JSONView("collapse")}),$("#expand-btn").on("click",function(){$("#destJSON").JSONView("expand")}),$("#toggle-level1-btn").on("click",function(){$("#destJSON").JSONView("toggle",1)}),$("#toggle-level2-btn").on("click",function(){$("#destJSON").JSONView("toggle",2)}),$("#toggle-level3-btn").on("click",function(){$("#destJSON").JSONView("toggle",3)}),$("#toggle-download-btn").on("click",function(){var t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent($("#sourceJSON").val())),t.setAttribute("download","formyll.json"),t.click()}),$("#json-row-btn").on("click",function(){$("#destJSON").is(":visible")?($("#destJSON").hide(),$("#json-row-btn").text("切换格式化"),$("#rowJSON").show().val(formatJSON(jsonString)),$(".tool-button-ul .tool-button-list:lt(6)").undelegate("click").css("background-color","#f9f9d9").css("cursor","not-allowed")):($("#rowJSON").hide(),$("#json-row-btn").text("切换原始值"),$("#destJSON").show(),$(".tool-button-ul .tool-button-list:lt(6)").delegate("click").css("background-color","white").css("cursor","pointer"))}),$("#json-compress-btn").on("click",function(){$("#rowJSON").is(":visible")?$("#rowJSON").show().val(formatJSON(jsonString,!0)):($("#json-row-btn").click(),$("#rowJSON").show().val(formatJSON(jsonString,!0)))}),$("#json-clean-btn").on("click",function(){window.localStorage.removeItem("historyJsonArray"),$("#destJSON").val(""),$("#rowJSON").val(""),$("#sourceJSON").val(""),$(".json-history").html('<option selected="selected" class="display-none">没有保存的纪录，请点击保存纪录按钮</option>')}),$("#json-save-btn").on("click",function(){historyJsonArray.push(encodeURI(jsonString)),window.localStorage.setItem("historyJsonArray",historyJsonArray),updateSelectHistory(historyJsonArray)}),$(".json-history").on("change",function(){$("#sourceJSON").val(decodeURI($(this).val()))})});